name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run ShellCheck on asb
        run: |
          shellcheck -x -s bash asb
          echo "ShellCheck passed for asb"

      - name: Run ShellCheck on test files
        run: |
          find tests -name "*.sh" -type f | while read -r file; do
            echo "Checking: $file"
            shellcheck -x -s bash "$file" || true
          done
          echo "ShellCheck completed for test files"

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: shellcheck
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          mkdir -p ~/.config/asb
          mkdir -p ~/.agent_settings_backups
          git config --global user.email "test@example.com"
          git config --global user.name "Test User"

      - name: Run unit tests
        id: unit-tests
        run: |
          echo "::group::Unit Test Output"
          ./tests/unit/run_unit_tests.sh 2>&1 | tee unit_test_output.txt
          exit_code=${PIPESTATUS[0]}
          echo "::endgroup::"
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: unit_test_output.txt
          retention-days: 7

  e2e-tests:
    name: E2E Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: unit-tests
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        test-file:
          - test_e2e.sh
          - test_error_paths.sh
          - test_verify.sh
          - test_schedule.sh
          - test_unicode.sh
          - test_symlinks.sh
          - test_large_files.sh
          - test_concurrent.sh
          - test_completion.sh
          - test_config.sh
          - test_conflict.sh
          - test_discover.sh
          - test_dryrun.sh
          - test_export.sh
          - test_hooks.sh
          - test_json.sh
          - test_stats.sh
          - test_tags.sh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install modern bash (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install bash
          echo "Using bash version: $($(brew --prefix)/bin/bash --version | head -1)"

      - name: Setup test environment
        run: |
          mkdir -p ~/.config/asb
          mkdir -p ~/.agent_settings_backups
          git config --global user.email "test@example.com"
          git config --global user.name "Test User"

      - name: Run E2E test - ${{ matrix.test-file }}
        id: e2e-test
        shell: bash
        run: |
          # On macOS, use Homebrew bash which supports associative arrays
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            export PATH="$(brew --prefix)/bin:$PATH"
          fi
          echo "::group::E2E Test: ${{ matrix.test-file }}"
          echo "Bash version: $(bash --version | head -1)"
          bash ./tests/${{ matrix.test-file }} 2>&1 | tee e2e_output_${{ matrix.test-file }}.txt
          exit_code=${PIPESTATUS[0]}
          echo "::endgroup::"
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-${{ matrix.os }}-${{ matrix.test-file }}
          path: e2e_output_${{ matrix.test-file }}.txt
          retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [shellcheck, unit-tests, e2e-tests]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary"
          echo ""
          echo "| Job | Status |"
          echo "|-----|--------|"
          echo "| ShellCheck | ${{ needs.shellcheck.result }} |"
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |"
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |"
          echo ""

          if [[ "${{ needs.shellcheck.result }}" != "success" ]] || \
             [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.e2e-tests.result }}" != "success" ]]; then
            echo "::error::Some tests failed!"
            exit 1
          else
            echo "::notice::All tests passed!"
          fi
